# -*- mode: makefile-gmake -*-


########################################
## AUTHOR: Per Thomas Hille pth@embc.no
## COPYRIGHT: Embedded Consulting A/S
########################################



##########################################################################
## This program is free software: you can redistribute it and/or modify
## it under the terms of the GNU General Public License as published by
## the Free Software Foundation, either version 3 of the License, or
## (at your option) any later version.
##
## This program is distributed in the hope that it will be useful,
## but WITHOUT ANY WARRANTY; without even the implied warranty of
## MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
## GNU General Public License for more details.
##
## You should have received a copy of the GNU General Public License
## along with this program.  If not, see <https://www.gnu.org/licenses/>.
##########################################################################

# This Makefile has two primary build targets: 'x86' and 'arm'
# When building each of these the Makefile will call itself with
# the TARGET variable set accordingly, but with no goals. For example:
# "make TARGET=arm". The TARGET variable is responsible for setting
# the value of the "all-src" list which contains all directories that
# shall be built for the given target.


export BUILDDIR=$(CURDIR)/build
export BINDIR=$(BUILDDIR)/$(TARGET)/bin
export LIBLOCAL=$(BUILDDIR)/$(TARGET)/lib
export INSTALLDIRS=$(BUILDDIR) $(BUILDDIR)/x86  $(BUILDDIR)/x86/bin  $(BUILDDIR)/x86/lib  $(BUILDDIR)/arm  $(BUILDDIR)/arm/bin  $(BUILDDIR)/arm/lib
export VERSIONINFO_EXE=$(BUILDDIR)/x86/bin/version-info



export LOGMASTER_HOME=$(PWD)
export COMMON_FLAGS:= -fPIC -ggdb  -O0  -fprofile-arcs -ftest-coverage  -std=c++23  -g   -Wno-psabi  -DFMT_HEADER_ONLY  -DGUI_DIR='"$(LOGMASTER_HOME)"' -DFMT_HEADER_ONLY
export PEDANTIC_FLAGS:=   -Weffc++ -Wshadow -Wall -Wextra -Wpedantic -Wno-psabi -Wno-unknown-pragmas -Wswitch-enum  -Wimplicit-fallthrough -Wignored-qualifiers -Wno-format-security  -Werror    

export HAS_LOGGING:=""
export LOGMASTER_HOME=$(PWD)
export CPPFLAGS:=           $(COMMON_FLAGS) $(PEDANTIC_FLAGS)   -DHAS_LOGGING
export CPPFLAGS_RELAXED:=   $(COMMON_FLAGS) $(PEDANTIC_FLAGS)   -DHAS_LOGGING
export XML_DIR:=$(CURDIR)/xml/3rd-party/
export XML_INCLUDES:= -I $(XML_DIR)
export LIBFLAGS:= -shared
export CONFIG_DIR:=$(PWD)/config

INCLUDES:= -I $(PWD)/include/  -isystem $(PWD)/include/system   -isystem $(PWD)/xml/xml/3rd-party  -isystem /usr/local/include/
GTEST_INCLUDES:= -isystem $(PWD)/productivity/
LIBS= -L $(PWD)/build/$(TARGET)/lib  -lm

export SUPPORT_LIBS:= -lcmdline -lutilities   -llogmaster 
export UNIT_TEST_LIBS:= $(SUPPORT_LIBS) -lgtest -lpthread 

version-info-exe:=           productivity/utilities/version-info/$(TARGET)
#gtest-embc:=             productivity/gtest-embc/$(TARGET)
utilities-lib:=              utilities/$(TARGET)
utilities-unittest-exe:=     utilities/unit-tests/commit/$(TARGET)
logging-lib:=                logging/$(TARGET)
logging-example1-exe:=           logging/examples/logging-example1/$(TARGET)
logging-example2-exe:=           logging/examples/logging-example2/$(TARGET)
logging-unittest-exe:=       logging/unit-tests/commit/$(TARGET)

cmdline-lib:=                cmdline/$(TARGET)
cmdline-example1-exe:=       cmdline/examples/cmdline-example1/$(TARGET)
cmdline-unittest-exe:=       cmdline/unit-tests/commit/$(TARGET)
xml-parser-lib:=             xml-parser/xml/$(TARGET)
xml-validator-exe:=          xml-parser/xml/xml-validator/$(TARGET)
xml-example1-exe:=           xml-parser/xml/exmples/xml-example1/$(TARGET)
xml-unittest-exe:=           xml-parser/xml/unit-tests/commit/$(TARGET) 
configurator-lib:=           configurator/$(TARGET)
configurator-unittest-exe:=  configurator/unit-tests/commit/$(TARGET)
logging-configurator-exe:=   configurator/logging-configurator/$(TARGET)
helloworld-exe:=             helloworld/$(TARGET)
issue-133-exe:=              bugs/issue-133/$(TARGET) 
issue-141-exe:=              bugs/issue-141/$(TARGET) 
db-test-exe:=                database-test/$(TARGET)
sqlite-lib:=                 productivity/sqlite/$(TARGET) 
api-logmaster-lib:=          api/api-logmaster/$(TARGET) 
gui-example1-exe:=           gui/logger/examples/gui-loggergui-example1/$(TARGET)
gui-example2-exe:=           gui/logmaster/examples/gui-qt-logmaster-example1/$(TARGET)
gui-alarm-lib:=              gui/alarm/$(TARGET) 
gui-logger-lib:=             gui/logger/$(TARGET) 
gui-logmaster-lib:=          gui/logmaster/$(TARGET) 
gui-common-lib:=             gui/common/$(TARGET) 
gui-alarm-example1-exe:=     gui/alarm/examples/gui-alarm-example1/$(TARGET) 


unittests:= 	$(utilities-unittest-exe) \
		        $(exception-unittest-exe) \
                $(logging-unittest-exe) \
		        $(cmdline-unittest-exe) \
				$(xml-unittest-exe)  


support-modules:= 	$(utilities-lib) \
			$(logging-lib) \
			$(cmdline-lib) \
			$(sqlite-lib) 


gui-lib+=$(gui-logger-lib) $(gui-logmaster-lib) $(gui-common-lib) $(gui-alarm-lib)
gui-exe+=$(gui-example1-exe)   $(gui-alarm-example1-exe) $(gui-example2-exe)  


src-lib-arm:= $(support-modules)

src-lib-x86:= $(src-lib-arm) $(xml-lib) $(support-modules) $(xml-parser-lib) $(configurator-lib)  $(api-logmaster-lib)


src-exe-arm:=$(cmdline-example1-exe) \
             $(db-test-exe)


src-exe:= $(src-exe-arm)

#	     $(version-info-exe)


arm-src:=$(src-lib-arm) $(src-exe)
x86-src:=$(src-lib-x86) $(src-exe)

all-clean:= $(src-lib-x86)  $(x86-src) $(configurator-unittest-exe) $(configurator-exe) \
            $(api-logmaster-lib)  $(xml-validator-exe) $(configurator-example1-exe) $(logging-configurator-exe)  $(gui-lib)  $(gui-exe)

ifeq (x86, $(TARGET))
unittests+= $(configurator-unittest-exe)
src-lib+= $(configurator-lib)  $(api-logmaster-lib)

src-exe+= $(xml-validator-exe) \
          $(logging-example1-exe) \
		  $(logging-example2-exe) \
          $(helloworld-exe) $(configurator-example1-exe) \
		  $(logging-configurator-exe) \
		  $(configurator-unittest-exe) \
		  $(unittests) $(version-info-exe) 

src-exe+= $(issue-133-exe) $(issue-141-exe)

x86-src:= $(src-lib) $(src-exe) 
all-src:=$(x86-src)
all-clean:=$(all-src)
endif

ifeq (arm, $(TARGET))
all-src:=$(arm-src)
src-lib:=$(src-lib-arm)

#src-exe+=$(unittests) 
endif

ifdef GUI
src-lib+=$(gui-lib)
src-exe+=$(gui-exe)
x86-src:= $(src-lib-x86) $(src-exe)
all-src:=$(x86-src)
endif

#default target is x86, we define it here to avoid checking for the arm compiler if
#compiling just for x86
export TARGET=x86

## Set compiler and archive builder to toolchain.
ifeq (x86, $(TARGET))
CCLOCAL:=c++   -std=c++23
ARLOCAL:=ar
else
LIBS+= -L$(CURDIR)/productivity/3rd-party/arm/lib/
CCLOCAL:=arm-linux-gnueabihf-g++  -std=c++23 -DARM
CC:= arm-linux-gnueabihf-gcc
ARLOCAL:=arm-linux-gnueabihf-ar
endif


ifdef CC-CROSS
CCLOCAL:=$(CC-CROSS)
endif


export


.PHONY: all $(all-src)
all: $(all-src)


.PHONY : gtest
gtest:
	cd gtest ;\
	cmake googletest-1.13.0 ;\
	make ;\
	cd .. ;\
	cp gtest/lib/* build/$(TARGET)/lib


$(version-info) : $(sqlite-lib)
$(unittests) : gtest
$(src-exe) : $(src-lib) $(version-info)
$(all-src):
	$(MAKE) --directory=$@ all

.PHONY: check-compiler
check-compiler:
	$(CCLOCAL) --version /dev/null;


$(INSTALLDIRS):
	mkdir -p $@

$(src-exe): $(version-info-exe)


x86:    $(INSTALLDIRS)
	$(MAKE) TARGET=x86

arm:    $(INSTALLDIRS)
	@$(MAKE) TARGET=arm


.PHONY : rcc
rcc:
	rcc   gui/resources/gui-qt.qrc  >  gui/resources/gui-qt.rcc


.PHONY : moc
moc: rcc
	./generate-moch.sh  $(gui-lib) $(gui-exe)


.PHONY: clean 
clean:  clean-x86 clean-arm
	@find -name *.d -exec rm {} \;
	@find -name *.gdb -exec rm {} \;
	@find -name *.o -exec rm {} \;


.PHONY: clean-x86
clean-x86:
	@for d in $(all-clean); \
	do \
	    $(MAKE)  --directory=$$d/x86  --no-print-directory clean TARGET=x86; \
	done
	@rm -rf build/x86

.PHONY: clean-arm
clean-arm:
	@for d in $(all-clean); \
	do \
	    $(MAKE)  --directory=$$d/x86  --no-print-directory clean TARGET=arm; \
	done
	@rm -rf build/x86

clean-logs:
	@rm -f *.log*  *.db
	@find -name  *.log* | xargs rm -f   


distclean: clean clean-logs
	@-$(RM) -r gtest/CMakeCache.txt
	@-$(RM) -r build
	@-$(RM) `find -name "SvnInfo*" | grep -v .svn`
	@find -name *.so    |  egrep  -v  3rd-party   |  egrep -v  '^\./googletest/'    |  egrep -v   '^\./arm-lib-dep/' |  xargs rm -f
	@find -name *.so.*  |  egrep  -v  3rd-party   |  egrep -v  '^\./googletest/'    |  egrep -v   '^\./arm-lib-dep/' |  xargs rm -f
	@find -name *.a     |  egrep  -v  3rd-party   |  egrep -v  '^\./googletest/'    |  xargs rm -f
	@find -name *.gcda -exec rm {} \;
	@find -name *.gcno -exec rm {} \;
	@find -name *~ -exec rm {} \;
	@find -name GVersion.cpp | xargs rm -f;
	@find -name tmp.cpp | xargs rm -f;

.PHONY: doc
doc:
	doxygen Doxyfile

